<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VinoBot 3k - Mapas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
</head>
<body>
    <div class="container">
        <h1>Seleccione un tipo de uva para visualizar el mapa</h1>

        <!-- Desplegable de variedades con valor por defecto -->
        <div class="form-group">
            <label for="variety_select">Elige un tipo de uva:</label>
            <select id="variety_select" class="form-control">
                <option value="" disabled selected>Seleccione un tipo de uva</option>
                <!-- Opciones se agregarán dinámicamente -->
            </select>
        </div>

        <!-- Botón para volver al índice -->
        <button class="btn btn-primary" onclick="window.location.href='/'">Volver al inicio</button>

        <div id="map" style="height: 600px; width: 100%; margin-top: 20px;"></div>
    </div>

    <!-- Script de JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Inicializar el mapa
        let map = L.map('map').setView([40.4168, -3.7038], 6); // Default to Madrid

        // Añadir la capa de mapas de OpenStreetMap
        let tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Cargar variedades en el desplegable
        fetch("/api/varieties")
            .then(response => response.json())
            .then(data => {
                const varietySelect = document.getElementById("variety_select");
                varietySelect.innerHTML = '';  // Limpiar el contenido actual

                // Verificamos que 'data.varieties' existe y tiene datos
                if (data && data.varieties && Array.isArray(data.varieties)) {
                    // Agregar opción por defecto
                    const defaultOption = document.createElement("option");
                    defaultOption.value = "";
                    defaultOption.textContent = "Seleccione un tipo de vino";
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    varietySelect.appendChild(defaultOption);

                    // Agregar las opciones de variedad al desplegable
                    data.varieties.forEach(variety => {
                        const option = document.createElement("option");
                        option.value = variety;
                        option.textContent = variety;
                        varietySelect.appendChild(option);
                    });
                } else {
                    varietySelect.innerHTML = '<option value="">No se encontraron variedades</option>';
                }
            })
            .catch(error => {
                console.error("Error al cargar las variedades:", error);
                const varietySelect = document.getElementById("variety_select");
                varietySelect.innerHTML = '<option value="">Error al cargar las variedades</option>';
            });

        // Lógica para mostrar el mapa interactivo basado en la variedad seleccionada
        document.getElementById("variety_select").addEventListener("change", function() {
            const variety = this.value;
            if (variety) {
                // Hacer una solicitud a la API para obtener los datos del mapa
                fetch(`/api/mapdata?wine_type=${variety}`)
                    .then(response => response.json())
                    .then(mapData => {
                        // Limpiar cualquier capa anterior del mapa
                        map.eachLayer(function(layer) {
                            if (layer !== tileLayer) {
                                map.removeLayer(layer);
                            }
                        });

                        // Añadir la capa de OpenStreetMap de nuevo
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(map);

                        // Dibuja el geo_shape (asumimos que el geo_shape es un objeto GeoJSON)
                        if (mapData && mapData.features) {
                            // Verifica que el geojson tiene el formato adecuado
                            L.geoJSON(mapData, {
                                onEachFeature: function (feature, layer) {
                                    layer.bindPopup("Variedad: " + feature.properties.name); // Personaliza popup si lo deseas
                                }
                            }).addTo(map);
                        } else {
                            console.log("No se encontraron datos de geo_shape para esta variedad.");
                        }

                        // Ajustar el centro del mapa y el zoom según los datos del mapa (opcional)
                        if (mapData && mapData.features) {
                            const bounds = L.geoJSON(mapData).getBounds();
                            map.fitBounds(bounds);
                        }
                    })
                    .catch(error => console.error("Error al cargar el mapa:", error));
            }
        });
    </script>
</body>
</html>